<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vacaciones 2026 - Air Europa LPA</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0;
      padding: 0;
    }
    
    .gradient-bg { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    }
    
    .loader {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .connection-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .connection-online { background: #d1fae5; color: #065f46; }
    .connection-offline { background: #fee2e2; color: #991b1b; }
    .connection-syncing { background: #fef3c7; color: #92400e; }

    .sync-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .dot-online { background: #10b981; box-shadow: 0 0 8px #10b981; }
    .dot-offline { background: #ef4444; }
    .dot-syncing { background: #f59e0b; animation: blink 1s infinite; }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .toast-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
    .toast-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
    .toast-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    const CONFIG = {
      GOOGLE_SHEETS_URL: 'https://script.google.com/macros/s/AKfycbwukCxdcdYhmD33DoP_Kcc2sAo96HUFDJYCg20AiNu0L0zqMHUsGZKdYLC0WUak6Ye6/exec',
      SYNC_INTERVAL: 30000,
      CACHE_DURATION: 5000,
      MAX_RETRIES: 3,
      RETRY_DELAY: 2000
    };

    class APIService {
      constructor() {
        this.cache = new Map();
        this.pendingRequests = new Map();
        this.lastSync = null;
      }

      async request(action, data = {}, retries = 0) {
        const cacheKey = `${action}-${JSON.stringify(data)}`;
        
        if (this.cache.has(cacheKey)) {
          const cached = this.cache.get(cacheKey);
          if (Date.now() - cached.timestamp < CONFIG.CACHE_DURATION) {
            return cached.data;
          }
        }

        if (this.pendingRequests.has(cacheKey)) {
          return this.pendingRequests.get(cacheKey);
        }

        const requestPromise = this._executeRequest(action, data, retries, cacheKey);
        this.pendingRequests.set(cacheKey, requestPromise);

        try {
          const result = await requestPromise;
          this.pendingRequests.delete(cacheKey);
          return result;
        } catch (error) {
          this.pendingRequests.delete(cacheKey);
          throw error;
        }
      }

      async _executeRequest(action, data, retries, cacheKey) {
        try {
          const response = await fetch(CONFIG.GOOGLE_SHEETS_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, ...data })
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const result = await response.json();

          if (result.error) {
            throw new Error(result.error);
          }

          this.cache.set(cacheKey, {
            data: result,
            timestamp: Date.now()
          });

          this.lastSync = new Date();
          return result;

        } catch (error) {
          console.error(`Error en ${action}:`, error);

          if (retries < CONFIG.MAX_RETRIES) {
            await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * (retries + 1)));
            return this.request(action, data, retries + 1);
          }

          throw error;
        }
      }

      clearCache() {
        this.cache.clear();
      }

      invalidateCache(pattern) {
        for (const key of this.cache.keys()) {
          if (key.includes(pattern)) {
            this.cache.delete(key);
          }
        }
      }
    }

    const apiService = new APIService();

    const ToastContainer = ({ toasts, removeToast }) => {
      return (
        <div className="toast-container">
          {toasts.map(toast => (
            <div key={toast.id} className={`toast toast-${toast.type}`}>
              <span className="text-xl">
                {toast.type === 'success' && '‚úì'}
                {toast.type === 'error' && '‚úó'}
                {toast.type === 'info' && '‚Ñπ'}
              </span>
              <span className="flex-1 font-semibold">{toast.message}</span>
              <button 
                onClick={() => removeToast(toast.id)}
                className="text-xl opacity-50 hover:opacity-100"
              >
                √ó
              </button>
            </div>
          ))}
        </div>
      );
    };

    const useToast = () => {
      const [toasts, setToasts] = useState([]);

      const addToast = useCallback((message, type = 'info') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type }]);
        
        setTimeout(() => {
          setToasts(prev => prev.filter(t => t.id !== id));
        }, 5000);
      }, []);

      const removeToast = useCallback((id) => {
        setToasts(prev => prev.filter(t => t.id !== id));
      }, []);

      return { toasts, addToast, removeToast };
    };

    const ConnectionIndicator = ({ status, lastSync }) => {
      const getStatusConfig = () => {
        switch (status) {
          case 'online':
            return { className: 'connection-online', dotClass: 'dot-online', text: 'Conectado' };
          case 'syncing':
            return { className: 'connection-syncing', dotClass: 'dot-syncing', text: 'Sincronizando...' };
          case 'offline':
            return { className: 'connection-offline', dotClass: 'dot-offline', text: 'Sin conexi√≥n' };
          default:
            return { className: 'connection-offline', dotClass: 'dot-offline', text: 'Desconectado' };
        }
      };

      const config = getStatusConfig();

      return (
        <div className={`connection-indicator ${config.className}`}>
          <span className={`sync-dot ${config.dotClass}`}></span>
          <span>{config.text}</span>
          {lastSync && status === 'online' && (
            <span className="text-xs opacity-75">
              ({lastSync.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })})
            </span>
          )}
        </div>
      );
    };

    const PantallaLogin = ({ onLogin, connectionStatus }) => {
      const [staffId, setStaffId] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [cargando, setCargando] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setCargando(true);

        try {
          const result = await apiService.request('login', { staffId, password });
          
          if (result.success) {
            onLogin(staffId, result.empleado);
          } else {
            setError(result.message || 'Credenciales incorrectas');
          }
        } catch (err) {
          setError(`Error de conexi√≥n: ${err.message}`);
          console.error('Error en login:', err);
        } finally {
          setCargando(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 via-blue-600 to-blue-800">
          <div className="absolute top-4 right-4">
            <ConnectionIndicator status={connectionStatus} />
          </div>
          
          <div className="bg-white p-10 rounded-3xl shadow-2xl max-w-md w-full mx-4">
            <div className="text-center mb-8">
              <h1 className="text-4xl font-bold text-gray-800 mb-2">üèñÔ∏è Vacaciones 2026</h1>
              <p className="text-gray-600">Sistema Colaborativo</p>
              <p className="text-sm text-gray-500 mt-1">Air Europa - LPA</p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">Staff ID</label>
                <input
                  type="text"
                  value={staffId}
                  onChange={(e) => setStaffId(e.target.value)}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none text-lg"
                  placeholder="Ej: 23428 o JEFE"
                  required
                  disabled={cargando}
                  autoFocus
                />
              </div>

              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">Contrase√±a</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none text-lg"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  disabled={cargando}
                />
              </div>

              {error && (
                <div className="bg-red-100 border-2 border-red-400 text-red-700 px-4 py-3 rounded-xl text-sm">
                  {error}
                </div>
              )}

              <button
                type="submit"
                disabled={cargando || connectionStatus === 'offline'}
                className="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:from-purple-700 hover:to-blue-700 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {cargando ? (
                  <div className="flex items-center justify-center gap-3">
                    <div className="loader" style={{ width: '20px', height: '20px', borderWidth: '3px' }}></div>
                    <span>Conectando...</span>
                  </div>
                ) : (
                  'Iniciar Sesi√≥n'
                )}
              </button>
            </form>

            <div className="mt-6 text-center text-sm text-gray-600">
              <p className="font-semibold mb-2">Acceso r√°pido:</p>
              <p>Tu Staff ID / (sin password)</p>
              <p>Admin: JEFE / admin2026</p>
            </div>
          </div>
        </div>
      );
    };

    function SistemaVacaciones() {
      const [mostrarLogin, setMostrarLogin] = useState(true);
      const [usuarioActual, setUsuarioActual] = useState(null);
      const [empleadoData, setEmpleadoData] = useState(null);
      const [connectionStatus, setConnectionStatus] = useState('offline');
      const [lastSync, setLastSync] = useState(null);
      const [datos, setDatos] = useState(null);
      const [cargandoDatos, setCargandoDatos] = useState(false);
      
      const { toasts, addToast, removeToast } = useToast();
      const syncIntervalRef = useRef(null);

      useEffect(() => {
        verificarConexion();
      }, []);

      const verificarConexion = async () => {
        try {
          setConnectionStatus('syncing');
          await apiService.request('ping');
          setConnectionStatus('online');
          setLastSync(new Date());
          addToast('‚úì Conexi√≥n establecida', 'success');
        } catch (error) {
          setConnectionStatus('offline');
          addToast('Sin conexi√≥n al servidor', 'error');
        }
      };

      const handleLogin = (staffId, empleado) => {
        setUsuarioActual(staffId);
        setEmpleadoData(empleado);
        setMostrarLogin(false);
        cargarDatos();
        iniciarSincronizacion();
        addToast(`Bienvenido, ${empleado.nombre}`, 'success');
      };

      const cargarDatos = async () => {
        setCargandoDatos(true);
        setConnectionStatus('syncing');
        
        try {
          const result = await apiService.request('getData');
          setDatos(result.data);
          setConnectionStatus('online');
          setLastSync(new Date());
        } catch (error) {
          setConnectionStatus('offline');
          addToast('Error al cargar datos', 'error');
        } finally {
          setCargandoDatos(false);
        }
      };

      const iniciarSincronizacion = () => {
        if (syncIntervalRef.current) clearInterval(syncIntervalRef.current);
        syncIntervalRef.current = setInterval(cargarDatos, CONFIG.SYNC_INTERVAL);
      };

      useEffect(() => {
        return () => {
          if (syncIntervalRef.current) clearInterval(syncIntervalRef.current);
        };
      }, []);

      if (mostrarLogin) {
        return <PantallaLogin onLogin={handleLogin} connectionStatus={connectionStatus} />;
      }

      if (cargandoDatos || !datos) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-50 to-gray-100">
            <div className="text-center">
              <div className="loader mb-4"></div>
              <p className="text-xl font-semibold text-gray-700">Cargando datos...</p>
            </div>
          </div>
        );
      }

      const esJefe = empleadoData?.esJefe || false;

      return (
        <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
          <ToastContainer toasts={toasts} removeToast={removeToast} />
          
          <div className="gradient-bg text-white py-6 shadow-2xl">
            <div className="container mx-auto px-4">
              <div className="flex justify-between items-center">
                <div>
                  <h1 className="text-3xl font-bold">Sistema de Vacaciones 2026</h1>
                  <p className="text-sm opacity-90 mt-1">
                    {esJefe ? 'üëî Panel Admin' : `üë§ ${empleadoData.nombre}`}
                  </p>
                  <p className="text-xs opacity-75">
                    Staff: {usuarioActual} | Grupo {empleadoData.grupo}
                  </p>
                </div>
                <div className="flex items-center gap-4">
                  <ConnectionIndicator status={connectionStatus} lastSync={lastSync} />
                  <button
                    onClick={() => {
                      if (confirm('¬øCerrar sesi√≥n?')) {
                        if (syncIntervalRef.current) clearInterval(syncIntervalRef.current);
                        setMostrarLogin(true);
                        setUsuarioActual(null);
                        setDatos(null);
                        apiService.clearCache();
                      }
                    }}
                    className="bg-white text-purple-600 px-6 py-3 rounded-xl font-bold hover:bg-gray-100"
                  >
                    Cerrar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div className="container mx-auto px-4 py-8">
            <div className="bg-white rounded-2xl shadow-lg p-8">
              <div className="text-center">
                <h2 className="text-3xl font-bold text-gray-800 mb-6">
                  üéâ ¬°Sistema Conectado!
                </h2>
                
                <div className="max-w-2xl mx-auto text-left space-y-4">
                  <div className="bg-green-50 border-2 border-green-200 rounded-xl p-4">
                    <h3 className="font-bold text-green-800 mb-2">‚úÖ Sesi√≥n activa</h3>
                    <p className="text-green-700 text-sm">
                      <strong>{empleadoData.nombre}</strong> | Staff {usuarioActual} | Grupo {empleadoData.grupo} | {empleadoData.puntos} pts
                    </p>
                  </div>

                  <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                    <h3 className="font-bold text-blue-800 mb-2">üìä Datos sincronizados</h3>
                    <p className="text-blue-700 text-sm">
                      Empleados: {datos.empleados.length} | Per√≠odos A: {datos.periodosA.length} | Per√≠odos B: {datos.periodosB.length}
                    </p>
                  </div>

                  <div className="bg-purple-50 border-2 border-purple-200 rounded-xl p-4">
                    <h3 className="font-bold text-purple-800 mb-2">üöÄ Sistema operativo</h3>
                    <p className="text-purple-700 text-sm">
                      Conexi√≥n: <strong className="text-green-600">Activa</strong> | Sync autom√°tico cada 30s
                    </p>
                  </div>
                </div>

                <button
                  onClick={() => { cargarDatos(); addToast('Datos recargados', 'info'); }}
                  className="mt-6 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-3 rounded-xl font-bold"
                >
                  üîÑ Recargar
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<SistemaVacaciones />, document.getElementById('root'));
  </script>
</body>
</html>
