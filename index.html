<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Vacaciones 2026 - COLABORATIVO</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* TODOS TUS ESTILOS ORIGINALES AQU√ç */
    /* ... (mant√©n todos tus estilos actuales) ... */
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ========================================
    // CONFIGURACI√ìN DEL BACKEND - ACTUALIZA ESTA URL
    // ========================================
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbwwPdc1TLku0YKap8zcCX5OEGsVKRthMsY-aLAJPDOcZOVK7pdzeZ8U4T9eFwZ6E6Ms/exec';

    // ========================================
    // SISTEMA DE PUNTUACI√ìN (igual que antes)
    // ========================================
    const PUNTOS_POR_MES = {
      1: { '1-15': 8, '16-31': 0 },
      2: { '1-29': 0 },
      3: { '1-31': 2 },
      4: { '1-30': 4 },
      5: { '1-31': 5 },
      6: { '1-15': 8, '16-30': 10 },
      7: { '1-31': 11 },
      8: { '1-31': 12 },
      9: { '1-15': 10, '16-30': 8 },
      10: { '1-31': 6 },
      11: { '1-30': 0 },
      12: { '1-15': 3, '16-31': 8 }
    };

    const calcularPuntosFecha = (fecha) => {
      const date = new Date(fecha);
      const mes = date.getMonth() + 1;
      const dia = date.getDate();
      
      const rangosMes = PUNTOS_POR_MES[mes];
      
      for (const [rango, puntos] of Object.entries(rangosMes)) {
        const [inicio, fin] = rango.split('-').map(Number);
        if (dia >= inicio && dia <= fin) {
          return puntos;
        }
      }
      
      return 0;
    };

    const calcularPuntosTotales = (periodos, compensados) => {
      let total = 0;
      
      periodos.forEach(periodo => {
        periodo.fechas.forEach(fecha => {
          total += calcularPuntosFecha(fecha);
        });
      });
      
      compensados.forEach(comp => {
        total += calcularPuntosFecha(comp.fecha);
      });
      
      return total;
    };

    // ========================================
    // DATOS EST√ÅTICOS (se cargan desde el backend)
    // ========================================
    const EMPLEADOS_DATA = {};
    const FESTIVOS_2026 = [
      '2026-01-01', '2026-01-06', '2026-02-17', '2026-04-02', '2026-04-03',
      '2026-05-01', '2026-05-30', '2026-06-24', '2026-08-15', '2026-09-08',
      '2026-10-12', '2026-11-02', '2026-12-08', '2026-12-25'
    ];

    const JEFE_STAFF_ID = '2817';

    const generarFechasAnio = () => {
      const fechas = [];
      for (let i = 0; i < 365; i++) {
        const fecha = new Date(Date.UTC(2026, 0, 1 + i));
        fechas.push(fecha.toISOString().split('T')[0]);
      }
      return fechas;
    };

    const FECHAS_2026 = generarFechasAnio();

    const obtenerIndiceDia = (fechaStr) => {
      const [year, month, day] = fechaStr.split('-').map(Number);
      const fechaUTC = new Date(Date.UTC(year, month - 1, day));
      const inicioUTC = new Date(Date.UTC(2026, 0, 1));
      const indice = Math.floor((fechaUTC - inicioUTC) / (1000 * 60 * 60 * 24));
      return indice;
    };

    const procesarAprobacionesAutomaticas = (periodos, todosLosEmpleados) => {
      periodos.forEach(periodo => {
        if (periodo.selecciones.length === 0) return;
        
        const seleccionesOrdenadas = [...periodo.selecciones].sort((a, b) => {
          const puntosA = todosLosEmpleados[a.staffId]?.puntos || 0;
          const puntosB = todosLosEmpleados[b.staffId]?.puntos || 0;
          return puntosA - puntosB;
        });
        
        seleccionesOrdenadas.forEach((sel, index) => {
          const seleccionOriginal = periodo.selecciones.find(s => s.staffId === sel.staffId);
          if (index < 2 && seleccionOriginal.estado === 'pendiente') {
            seleccionOriginal.estado = 'aprobado_auto';
            seleccionOriginal.observaciones = 'Aprobado autom√°ticamente por sistema de puntos';
          } else if (index >= 2 && seleccionOriginal.estado !== 'aprobado' && seleccionOriginal.estado !== 'rechazado') {
            seleccionOriginal.estado = 'pendiente';
          }
        });
      });
      
      return periodos;
    };

    // ========================================
    // SERVICIOS PARA CONECTAR CON EL BACKEND
    // ========================================
    const apiService = {
      async callBackend(action, data = {}) {
        try {
          // Para Google Apps Script, usamos parameters en lugar de body para POST
          const formData = new FormData();
          formData.append('action', action);
          formData.append('data', JSON.stringify(data));
          
          const response = await fetch(BACKEND_URL, {
            method: 'POST',
            body: formData
          });
          
          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
          }
          
          const result = await response.json();
          
          if (result.success) {
            return result.data;
          } else {
            throw new Error(result.error || 'Error desconocido');
          }
        } catch (error) {
          console.error('Error al conectar con el backend:', error);
          throw error;
        }
      },
      
      async obtenerDatos() {
        return await this.callBackend('obtenerDatos');
      },
      
      async guardarSeleccionPeriodo(staffId, numeroPeriodo, accion) {
        return await this.callBackend('guardarSeleccionPeriodo', {
          staffId,
          numeroPeriodo,
          accion
        });
      },
      
      async guardarSeleccionCompensado(staffId, fecha, accion) {
        return await this.callBackend('guardarSeleccionCompensado', {
          staffId,
          fecha,
          accion
        });
      },
      
      async cambiarEstado(staffId, tipo, identificador, nuevoEstado, observaciones) {
        return await this.callBackend('cambiarEstado', {
          staffId,
          tipo,
          identificador,
          nuevoEstado,
          observaciones
        });
      },
      
      async verificarCredenciales(staffId, pin) {
        return await this.callBackend('verificarCredenciales', {
          staffId,
          pin
        });
      },
      
      async crearPin(staffId, pin) {
        return await this.callBackend('crearPin', {
          staffId,
          pin
        });
      }
    };

    function SistemaVacaciones() {
      const [usuarioActual, setUsuarioActual] = useState(null);
      const [mostrarLogin, setMostrarLogin] = useState(true);
      const [vista, setVista] = useState('calendario');
      const [modoSeleccion, setModoSeleccion] = useState('periodo');
      const [empleadoSeleccionadoJefe, setEmpleadoSeleccionadoJefe] = useState(null);
      const [cargando, setCargando] = useState(false);
      const [errorBackend, setErrorBackend] = useState(null);
      
      // CARGAR DATOS DESDE EL BACKEND
      const [datosGlobales, setDatosGlobales] = useState({
        periodos_a: [],
        periodos_b: [],
        compensados: {},
        empleados: {}
      });

      // Cargar datos iniciales del backend
      useEffect(() => {
        const cargarDatos = async () => {
          if (mostrarLogin) return;
          
          setCargando(true);
          try {
            const datos = await apiService.obtenerDatos();
            
            // Actualizar datos est√°ticos de empleados
            Object.assign(EMPLEADOS_DATA, datos.empleados);
            
            // Procesar aprobaciones autom√°ticas
            datos.periodos_a = procesarAprobacionesAutomaticas(datos.periodos_a, datos.empleados);
            datos.periodos_b = procesarAprobacionesAutomaticas(datos.periodos_b, datos.empleados);
            
            setDatosGlobales(datos);
            setErrorBackend(null);
          } catch (error) {
            console.error('Error al cargar datos:', error);
            setErrorBackend('No se pudo conectar con el servidor. Los datos pueden no estar actualizados.');
          } finally {
            setCargando(false);
          }
        };
        
        cargarDatos();
      }, [mostrarLogin]);

      const esJefe = usuarioActual === JEFE_STAFF_ID;
      const empleadoData = usuarioActual && usuarioActual !== JEFE_STAFF_ID ? 
        datosGlobales.empleados[usuarioActual] : null;
      const periodosActuales = empleadoData?.grupo === 'A' ? 
        datosGlobales.periodos_a : datosGlobales.periodos_b;

      // ... (EL RESTO DE TU C√ìDIGO REACT PERMANECE IGUAL)
      // PantallaLogin, CalendarioAnualInteractivo, PanelAdmin, etc.
      // Solo aseg√∫rate de usar datosGlobales.empleados en lugar de EMPLEADOS_DATA

      // LOGIN (actualizado para usar el backend)
      const PantallaLogin = () => {
        const [staffInput, setStaffInput] = useState('');
        const [pinInput, setPinInput] = useState('');
        const [error, setError] = useState('');

        const handleLogin = async () => {
          const staffId = staffInput.trim();

          try {
            const resultado = await apiService.verificarCredenciales(staffId, pinInput);
            
            if (resultado.existe && resultado.pinCorrecto) {
              setUsuarioActual(staffId);
              setMostrarLogin(false);
              setVista(staffId === JEFE_STAFF_ID ? 'admin' : 'calendario');
            } else if (!resultado.existe && pinInput.length === 4) {
              // Crear nuevo PIN
              await apiService.crearPin(staffId, pinInput);
              setUsuarioActual(staffId);
              setMostrarLogin(false);
              setVista(staffId === JEFE_STAFF_ID ? 'admin' : 'calendario');
            } else {
              setError('PIN incorrecto o usuario no encontrado');
            }
          } catch (error) {
            console.error('Error en login:', error);
            setError('Error al conectar con el servidor');
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700 p-4">
            <div className="bg-white rounded-3xl shadow-2xl p-10 max-w-md w-full">
              <div className="text-center mb-8">
                <div className="text-6xl mb-4">üèñÔ∏è</div>
                <h1 className="text-4xl font-bold text-gray-800 mb-2">Sistema de Vacaciones</h1>
                <p className="text-gray-600 text-lg">A√±o 2026 - Colaborativo</p>
                <div className="mt-4 inline-block bg-green-100 text-green-800 px-4 py-2 rounded-full text-sm font-semibold">
                  üåê Conectado a Google Sheets
                </div>
              </div>
              
              <div className="space-y-5">
                <div>
                  <label className="block text-sm font-bold text-gray-700 mb-2">
                    N√∫mero de Staff
                  </label>
                  <input
                    type="text"
                    value={staffInput}
                    onChange={(e) => {
                      setStaffInput(e.target.value);
                      setError('');
                    }}
                    className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none text-lg"
                    placeholder="Ej: 5088 o 2817 (jefe)"
                    onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold text-gray-700 mb-2">
                    {staffInput ? 'PIN de 4 d√≠gitos' : 'Ingresa tu Staff ID primero'}
                  </label>
                  <input
                    type="password"
                    maxLength="4"
                    value={pinInput}
                    onChange={(e) => {
                      setPinInput(e.target.value.replace(/\D/g, ''));
                      setError('');
                    }}
                    className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none text-2xl text-center tracking-widest font-bold"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                    disabled={!staffInput}
                  />
                </div>

                {error && (
                  <div className="bg-red-50 border-2 border-red-300 text-red-700 px-4 py-3 rounded-xl text-sm font-semibold">
                    ‚ö†Ô∏è {error}
                  </div>
                )}

                <button
                  onClick={handleLogin}
                  disabled={!staffInput || pinInput.length !== 4}
                  className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-4 rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all transform hover:scale-105 shadow-lg text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {staffInput && !datosGlobales.empleados[staffInput]?.pin ? 
                    'Crear PIN ‚Üí' : 'Iniciar Sesi√≥n ‚Üí'}
                </button>

                <div className="text-center text-sm text-gray-500 mt-6 pt-4 border-t">
                  <p className="font-semibold">Sistema Colaborativo</p>
                  <p className="text-xs mt-1">Los datos se sincronizan en tiempo real con Google Sheets</p>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // ... (EL RESTO DE TUS COMPONENTES REACT - 
      // aseg√∫rate de usar datosGlobales.empleados en lugar de EMPLEADOS_DATA)

      return (
        <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
          {cargando && (
            <div className="loading-overlay">
              <div className="loading-spinner"></div>
              <div className="text-white mt-4 font-semibold">Cargando datos...</div>
            </div>
          )}
          
          {errorBackend && (
            <div className="no-print bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert">
              <p className="font-bold">Advertencia</p>
              <p>{errorBackend}</p>
            </div>
          )}
          
          {mostrarLogin ? (
            <PantallaLogin />
          ) : (
            /* TU INTERFAZ PRINCIPAL AQU√ç */
            <div>
              {/* Header */}
              <div className="gradient-bg text-white py-6 shadow-2xl no-print">
                <div className="container mx-auto px-4 flex justify-between items-center">
                  <div>
                    <h1 className="text-3xl font-bold">Sistema de Vacaciones 2026</h1>
                    <p className="text-sm opacity-90 mt-1">
                      {esJefe ? 'üëî Panel de Administraci√≥n' : 
                       `üë§ ${empleadoData?.nombre} - Staff: ${usuarioActual}`}
                    </p>
                  </div>
                  <button
                    onClick={() => {
                      if (confirm('¬øCerrar sesi√≥n?')) {
                        setMostrarLogin(true);
                        setUsuarioActual(null);
                        setVista('calendario');
                      }
                    }}
                    className="bg-white text-purple-600 px-6 py-3 rounded-xl font-bold hover:bg-gray-100 transition-all shadow-lg"
                  >
                    Cerrar Sesi√≥n
                  </button>
                </div>
              </div>

              {/* Contenido principal */}
              <div className="container mx-auto px-4 py-8">
                {/* Aqu√≠ van tus componentes de vista */}
                {/* CalendarioAnualInteractivo, PanelAdmin, etc. */}
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<SistemaVacaciones />, document.getElementById('root'));
  </script>
</body>
</html>